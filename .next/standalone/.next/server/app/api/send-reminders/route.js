"use strict";(()=>{var e={};e.id=8637,e.ids=[8637],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},99830:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>f,originalPathname:()=>k,patchFetch:()=>q,requestAsyncStorage:()=>x,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>v});var s={};t.r(s),t.d(s,{POST:()=>c});var n=t(95419),i=t(69108),o=t(99678),a=t(98984),l=t(86323),d=t(68140),p=t(7439),u=t(57699);async function c(e){try{let e=(0,p.cookies)(),r=(0,u.createRouteHandlerClient)({cookies:()=>e}),{data:{session:t},error:s}=await r.auth.getSession();if(s||!t||!t.user)return a.NextResponse.json({error:"Du m\xe5 v\xe6re logget inn for \xe5 utf\xf8re denne handlingen"},{status:401});let n=t.user.id,i=(0,l.eI)("https://rfexljxsabsbfbszzvjf.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{persistSession:!1}}),o=new Date;o.setDate(o.getDate()-2);let{data:c,error:g}=await i.from("sent_emails").select("*").eq("user_id",n).is("clicked_at",null).is("reminder_sent_at",null).lt("sent_at",o.toISOString());if(g)return console.error("Error fetching emails needing reminders:",g),a.NextResponse.json({error:g.message||"Feil ved henting av e-poster"},{status:500});if(!c||0===c.length)return a.NextResponse.json({sentCount:0,message:"Ingen p\xe5minnelser \xe5 sende"});let x=d.createTransport({host:process.env.EMAIL_SERVER,port:Number(process.env.EMAIL_PORT),secure:!1,auth:{user:process.env.EMAIL_USERNAME,pass:process.env.EMAIL_PASSWORD}}),m=c.map(async e=>{try{let r=process.env.BASE_URL||"http://localhost:3000",t=`${r}/api/track-click?token=${e.token}`;await x.sendMail({from:process.env.EMAIL_FROM,to:e.email,subject:"P\xe5minnelse: Vi \xf8nsker fortsatt din tilbakemelding! \uD83C\uDF1F",html:`
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px;">
              <h2 style="color: #333; margin-bottom: 20px;">Hei ${e.name}!</h2>
              <p style="color: #555; font-size: 16px; line-height: 1.5;">Vi ser at du enn\xe5 ikke har gitt oss en vurdering. Din tilbakemelding er veldig viktig for oss!</p>
              <p style="color: #555; font-size: 16px; line-height: 1.5;">Det tar bare 30 sekunder \xe5 gi en vurdering:</p>
              <div style="text-align: center; margin: 30px 0;">
                <a href="${t}" style="background-color: #4CAF50; color: white; padding: 12px 25px; text-decoration: none; border-radius: 4px; font-weight: bold; font-size: 16px; display: inline-block;">Gi din vurdering</a>
              </div>
              <p style="color: #555; font-size: 16px; line-height: 1.5;">Tusen takk for din hjelp!</p>
              <p style="color: #555; font-size: 16px; line-height: 1.5;">Med vennlig hilsen,<br>${process.env.EMAIL_FROM_NAME}</p>
            </div>
          `,text:`
Hei ${e.name}!

Vi ser at du enn\xe5 ikke har gitt oss en vurdering. Din tilbakemelding er veldig viktig for oss!
Det tar bare 30 sekunder \xe5 gi en vurdering.

Du kan gi din vurdering her: ${t}

Tusen takk for din hjelp!

Med vennlig hilsen,
${process.env.EMAIL_FROM_NAME}
          `});let s=new Date().toISOString(),{error:n}=await i.from("sent_emails").update({reminder_sent_at:s}).eq("id",e.id);if(n)return console.error(`Error updating reminder status for email ${e.id}:`,n),{success:!1,id:e.id,error:n.message};return{success:!0,id:e.id}}catch(r){return console.error(`Error sending reminder for email ${e.id}:`,r),{success:!1,id:e.id,error:r.message}}}),h=(await Promise.all(m)).filter(e=>e.success).length;return a.NextResponse.json({sentCount:h,totalCount:c.length,message:`${h} av ${c.length} p\xe5minnelser ble sendt`})}catch(e){return console.error("Error sending reminders:",e),a.NextResponse.json({error:"En uventet feil oppstod: "+e.message},{status:500})}}let g=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/send-reminders/route",pathname:"/api/send-reminders",filename:"route",bundlePath:"app/api/send-reminders/route"},resolvedPagePath:"/Users/ulrikdalanfjellstad/Desktop/Revlo/app/api/send-reminders/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:x,staticGenerationAsyncStorage:m,serverHooks:h,headerHooks:f,staticGenerationBailout:v}=g,k="/api/send-reminders/route";function q(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[1638,5665,2791,3421,5976],()=>t(99830));module.exports=s})();