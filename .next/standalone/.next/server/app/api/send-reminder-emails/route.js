"use strict";(()=>{var e={};e.id=5793,e.ids=[5793],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},50112:(e,r,s)=>{s.r(r),s.d(r,{headerHooks:()=>q,originalPathname:()=>S,patchFetch:()=>M,requestAsyncStorage:()=>b,routeModule:()=>y,serverHooks:()=>_,staticGenerationAsyncStorage:()=>w,staticGenerationBailout:()=>A});var t={};s.r(t),s.d(t,{GET:()=>h,POST:()=>v});var n=s(95419),o=s(69108),i=s(99678),a=s(98984),l=s(86323),d=s(57699),u=s(68140),c=s(7439);let p=(0,l.eI)("https://rfexljxsabsbfbszzvjf.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function m(e){let{data:r,error:s}=await p.rpc("get_pending_reminders").eq("user_id",e);if(s)throw console.error("Error fetching customers needing reminder:",s),s;return r||[]}async function g(){let{data:e,error:r}=await p.rpc("get_pending_reminders");if(r)throw console.error("Error fetching customers needing reminder:",r),r;return e||[]}async function f(e){let r=process.env.BASE_URL||"http://localhost:3000",s=e.review_link;if(e.token&&(s=`${r}/api/track-click?token=${e.token}`),!s)throw Error("No review link or token available for tracking");let t=u.createTransport({host:process.env.EMAIL_SERVER,port:Number(process.env.EMAIL_PORT),secure:!1,auth:{user:process.env.EMAIL_USERNAME,pass:process.env.EMAIL_PASSWORD}}),n=`
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px;">
      <h2 style="color: #333; margin-bottom: 20px;">Hei ${e.name||"der"}!</h2>
      <p style="color: #555; font-size: 16px; line-height: 1.5;">Vi sendte deg en foresp\xf8rsel om tilbakemelding for noen dager siden, men har ikke h\xf8rt fra deg enn\xe5.</p>
      <p style="color: #555; font-size: 16px; line-height: 1.5;">Vi setter stor pris p\xe5 om du kan ta et \xf8yeblikk til \xe5 dele din erfaring med oss.</p>
      <div style="text-align: center; margin: 30px 0;">
        <a href="${s}" style="background-color: #4CAF50; color: white; padding: 12px 25px; text-decoration: none; border-radius: 4px; font-weight: bold; display: inline-block;">Gi din vurdering</a>
      </div>
      <p style="color: #555; font-size: 16px; line-height: 1.5;">Takk for din tid!</p>
      <p style="color: #555; font-size: 16px; line-height: 1.5;">Med vennlig hilsen,<br>${process.env.EMAIL_FROM_NAME}</p>
    </div>
  `,o=`
Hei ${e.name||"der"}!

Vi sendte deg en foresp\xf8rsel om tilbakemelding for noen dager siden, men har ikke h\xf8rt fra deg enn\xe5.
Vi setter stor pris p\xe5 om du kan ta et \xf8yeblikk til \xe5 dele din erfaring med oss.

Gi din vurdering her: ${s}

Takk for din tid!

Med vennlig hilsen,
${process.env.EMAIL_FROM_NAME}
  `;await t.sendMail({from:process.env.EMAIL_FROM,to:e.email,subject:"P\xe5minnelse: Vi \xf8nsker fortsatt din tilbakemelding! \uD83C\uDF1F",html:n,text:o})}async function x(e){let r=new Date().toISOString(),{error:s}=await p.from("sent_emails").update({status:"REMINDER_SENT",reminder_sent_at:r}).eq("id",e);if(s)throw console.error(`Error updating status for ID ${e}:`,s),s;return{id:e,timestamp:r}}async function h(e){console.log("Reminder email check started at:",new Date().toISOString());try{if(!process.env.EMAIL_USERNAME||!process.env.EMAIL_PASSWORD)return console.error("Missing email credentials in environment variables"),a.NextResponse.json({error:"E-postinnstillinger mangler i milj\xf8variablene"},{status:500});if("true"===e.headers.get("x-vercel-cron"))return console.log("Running as cron job - processing all users"),await R();return console.log("Running as manual API call - checking user session"),await k()}catch(e){return console.error("Unhandled error in reminder process:",e),a.NextResponse.json({error:"Systemfeil ved behandling av p\xe5minnelser",message:e.message},{status:500})}}async function v(e){return h(e)}async function R(){try{let e=await g(),r={totalPendingReminders:e.length,sentEmails:0,errors:0,userResults:{}};if(0===e.length)return console.log("No pending reminders found"),a.NextResponse.json({message:"No reminders needed",totalPendingReminders:0});for(let s of e){let e=s.user_id;r.userResults[e]||(r.userResults[e]={total:0,sent:0,errors:0,details:[]}),r.userResults[e].total++;try{await f(s),await x(s.id),r.sentEmails++,r.userResults[e].sent++,r.userResults[e].details.push({id:s.id,email:s.email,status:"success"}),console.log(`Successfully sent reminder to ${s.email}`)}catch(t){console.error(`Error sending reminder to ${s.email}:`,t),r.errors++,r.userResults[e].errors++,r.userResults[e].details.push({id:s.id,email:s.email,status:"error",message:t.message})}}return console.log("Cron job completed with results:",{totalPendingReminders:r.totalPendingReminders,sentEmails:r.sentEmails,errors:r.errors}),a.NextResponse.json(r)}catch(e){return console.error("Error in cron job processing:",e),a.NextResponse.json({error:"Failed to process cron job",message:e.message},{status:500})}}async function k(){let e=(0,d.createServerComponentClient)({cookies:c.cookies}),{data:{session:r},error:s}=await e.auth.getSession();if(s||!r||!r.user)return console.error("Authentication error:",s||"No active session"),a.NextResponse.json({error:"Du m\xe5 v\xe6re logget inn for \xe5 utf\xf8re denne handlingen"},{status:401});try{let e=r.user.id,s=await E(e);return a.NextResponse.json(s)}catch(e){return console.error("Error processing manual request:",e),a.NextResponse.json({error:"Kunne ikke behandle p\xe5minnelser",message:e.message},{status:500})}}async function E(e){let r=await m(e);if(console.log(`Processing ${r.length} reminders for user ${e}`),0===r.length)return{message:"No reminders needed",total:0,sent:0,errors:0};let s={total:r.length,sent:0,errors:0,details:[]};for(let e of r)try{await f(e),await x(e.id),s.sent++,s.details.push({id:e.id,email:e.email,status:"success"}),console.log(`Successfully sent reminder to ${e.email}`)}catch(r){console.error(`Error sending reminder to ${e.email}:`,r),s.errors++,s.details.push({id:e.id,email:e.email,status:"error",message:r.message})}return s}let y=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/send-reminder-emails/route",pathname:"/api/send-reminder-emails",filename:"route",bundlePath:"app/api/send-reminder-emails/route"},resolvedPagePath:"/Users/ulrikdalanfjellstad/Desktop/Revlo/app/api/send-reminder-emails/route.ts",nextConfigOutput:"standalone",userland:t}),{requestAsyncStorage:b,staticGenerationAsyncStorage:w,serverHooks:_,headerHooks:q,staticGenerationBailout:A}=y,S="/api/send-reminder-emails/route";function M(){return(0,i.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:w})}}};var r=require("../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[1638,5665,2791,3421,5976],()=>s(50112));module.exports=t})();